<dom-module id="coffee-subapp">
    <style>
        * { font-weight: 200; }
        strong * { font-weight: 500; }
        li {
            list-style: none;
            display: inline-block;
            margin: 0.5rem;
        }
        .coffee {
            position: relative;
            padding: 0.5rem;
            width: 12rem;
            text-align: center;
        }
        .coffee strong, .coffee em {
            display: block;
        }
        .price {
            padding: 0.5rem;
        }
    </style>
    <template>
        <h2>Coffee</h2>

        <firebase-collection id="fb"
            location="https://swcoffee.firebaseio.com/inventory"
            data="{{coffees}}"
            order-by-child="type"
            equal-to="coffee">
        </firebase-collection>

        <firebase-collection id="fbprices"
            location="https://swcoffee.firebaseio.com/prices"
            data="{{prices}}">
        </firebase-collection>

        <iron-ajax id="ajax"
             handle-as="json"
             on-response="handleResponse">
         </iron-ajax>

        <paper-button raised on-tap="rescan">Scrape Sweetwater</paper-button>
        <div id="message"></div>

        <ul class="horizontal layout start wrap">
            <template is="dom-repeat" items="{{coffees}}">
                <li>
                    <paper-material elevation="1" class="coffee">
                        <img src="{{item.img}}">
                        <em>{{item.name}}</em>
                        <currency-display value="{{item.price}}"></currency-display>
                    </paper-material>
                </li>
            </template>
        </ul>

        <ul>
        <template is="dom-repeat" items="{{prices}}" as="price">
            <li>
                <paper-material elevation="1" class="price">
                    <div>
                        <span>Retail:</span>
                        <currency-display value="{{price.retail}}"></currency-display>
                    </div>
                    <div class="vertical layout">
                        <paper-input label="1 lb." type="number" value="{{price.wholesale.0}}">
                            <div prefix>$</div>
                        </paper-input>
                        <paper-input label="2 lbs." type="number" value="{{price.wholesale.1}}">
                            <div prefix>$</div>
                        </paper-input>
                        <paper-input label="5 lbs." type="number" value="{{price.wholesale.2}}">
                            <div prefix>$</div>
                        </paper-input>
                    </div>
                </paper-material>
            </li>
        </template>
        </ul>
    </template>
</dom-module>
<script>
    function zip(arrays) {
        return arrays[0].map((_,i) => arrays.map(a => a[i]));
    }

    Polymer({
        is: 'coffee-subapp',
        rescan: function () {
            var yql = encodeURIComponent('SELECT * FROM data.html.cssselect WHERE url="http://www.sweetwaterorganiccoffee.com/coffee/" AND css=".ProductList"');
            var queryuri = `https://query.yahooapis.com/v1/public/yql?q=${yql}&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys`;
            this.$.ajax.url = queryuri;
            this.$.ajax.generateRequest();
        },
        handleResponse: function (data) {
            var allprices = [];
            var query = data.detail.response.query;

            new Firebase('https://swcoffee.firebaseio.com/inventory').remove();
            new Firebase('https://swcoffee.firebaseio.com/prices').remove();

            if (!query.results) {
                this.$.message.innerText = 'No results for query';
                return;
            }

            query.results.results.ul.li.forEach(function (li) {
                var names = li.div.filter(d => d.class.indexOf('ProductDetails') !== -1).map(d => d.strong.a.content);
                var images = li.div.filter(d => d.class.indexOf('QuickView') !== -1).map(d => d.a.img.src);
                var prices = li.div
                    .filter(d => d.class.indexOf('Price') !== -1)
                    .map(d => typeof d.em === 'object'
                        ? parseInt(parseFloat(d.em.span.content.replace('\$', '')) * 100)
                        : parseInt(parseFloat(d.em.replace('\$', '')) * 100));

                zip([names, prices, images]).forEach(d => {
                    this.$.fb.add({
                        name: d[0],
                        price: d[1],
                        img: d[2],
                        type: 'coffee'
                    });

                    allprices.push({retail: d[1], wholesale: [8.75, 17.00, 41.25]});
                });
            }.bind(this));

            var uniquePrices = {};
            allprices.forEach(p => uniquePrices[p.retail] = p);
            for (k in uniquePrices) {
                this.$.fbprices.add(uniquePrices[k]);
            }
        }
    });
</script>