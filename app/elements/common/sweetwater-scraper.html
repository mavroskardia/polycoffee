<dom-module id="sweetwater-scraper">
    <style include="shared-styles"></style>
    <template>
        <iron-ajax id="ajax"
             handle-as="json"
             on-response="handleResponse">
         </iron-ajax>
         <paper-toast id="message"></paper-toast>
    </template>
</dom-module>
<script>
    function zip(arrays) {
        return arrays[0].map((_,i) => arrays.map(a => a[i]));
    }

    Polymer({
        is: 'sweetwater-scraper',
        properties: {
            coffees: {
                type: Array,
                value: function () {
                    return [];
                },
                notify: true
            },
            prices: {
                type: Array,
                value: function () {
                    return [];
                },
                notify: true
            }
        },
        scrape: function () {
            var yql = encodeURIComponent('SELECT * FROM data.html.cssselect WHERE url="http://www.sweetwaterorganiccoffee.com/coffee/" AND css=".ProductList"');
            var queryuri = `https://query.yahooapis.com/v1/public/yql?q=${yql}&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys`;
            this.$.ajax.url = queryuri;
            this.$.ajax.generateRequest();
        },
        handleResponse: function (data) {
            var allprices = [],
                coffees = [],
                query = data.detail.response.query;

            if (!query.results) {
                this.$.message.text = 'Failed to scrape Sweetwater: YQL returned nothing.';
                this.$.message.open();
                return;
            }

            query.results.results.ul.li.forEach(function (li) {
                var names = li.div.filter(d => d.class.indexOf('ProductDetails') !== -1).map(d => d.strong.a.content);
                var images = li.div.filter(d => d.class.indexOf('QuickView') !== -1).map(d => d.a.img.src);
                var prices = li.div
                    .filter(d => d.class.indexOf('Price') !== -1)
                    .map(d => typeof d.em === 'object'
                        ? parseInt(parseFloat(d.em.span.content.replace('\$', '')) * 100)
                        : parseInt(parseFloat(d.em.replace('\$', '')) * 100));

                zip([names, prices, images]).forEach(function (d) {
                    this.push('coffees', {
                        name: d[0],
                        price: d[1],
                        img: d[2],
                        type: 'coffee'
                    });

                    allprices.push({retail: d[1], wholesale: [8.75, 17.00, 41.25]});
                }.bind(this));
            }.bind(this));

            var uniquePrices = {};
            allprices.forEach(p => uniquePrices[p.retail] = p);
            this.prices = [];
            for (var k in uniquePrices) {
                this.push('prices', uniquePrices[k]);
            }

            this.$.message.text = 'Successfully scraped Sweetwater';
            this.$.message.open();
            this.fire('scrape-success');
        }
    });
</script>
