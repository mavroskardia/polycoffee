<dom-module id="order-view">
    <style>
        paper-material { padding: 1rem; }
        .spaced { margin: 0 0.5rem; }
        #fields > * { margin: 0.5rem 0; }
        coffee-dropdown, person-dropdown { display: block; }
        .lineitems li { border-bottom: solid 1px #eee; list-style: none; }
        .lineitems li order-lineitem { width: 100%; }
        #personal { display: block; }
    </style>
    <template>
        <firebase-collection id="teamitems"
            location="https://swcoffee.firebaseio.com/teamitems"
            order-by-child="order"
            equal-to="[[order.__firebaseKey__]]"
            data="{{teamitems}}">
        </firebase-collection>

        <firebase-collection id="personalitems"
            location="https://swcoffee.firebaseio.com/personalitems"
            order-by-child="order"
            equal-to="[[order.__firebaseKey__]]"
            data="{{personalitems}}">
        </firebase-collection>

        <h2>Order for <span>{{toDate(order.date)}}</span> (<span>{{order.status}}</span>)</h2>

        <div class="layout horizontal">
            <team-dropdown order="{{order}}" disabled="{{!isOpen}}" class="flex"></team-dropdown>
            <order-totals order="{{order}}"></order-totals>
        </div>

        <div class="horizontal layout wrap">
            <div class="spaced">
                <h4>Add to Order</h4>
                <paper-material elevation="1">
                    <coffee-dropdown coffee="{{coffee}}" on-iron-select="enableAdd"></coffee-dropdown>
                    <coffee-bag-size size="{{bagsize}}"></coffee-bag-size>
                    <coffee-quantity quantity="{{quantity}}"></coffee-quantity>
                    <paper-checkbox id="personal" checked="{{ispersonal}}">Personal Order</paper-checkbox>
                    <person-dropdown disabled="{{!ispersonal}}" team="{{order.team}}" person="{{person}}"></person-dropdown>
                    <paper-button id="addButton" raised disabled on-tap="add">Add</paper-button>
                </paper-material>
            </div>
            <div class="flex-2 spaced">
                <h4>Order Items</h4>
                <paper-tabs id="tabs" selected="{{selected}}">
                    <paper-tab id="teamtab">Team</paper-tab>
                    <paper-tab id="personaltab">Personal</paper-tab>
                </paper-tabs>
                <paper-material elevation="1">
                    <iron-pages selected="[[selected]]">
                        <ul class="lineitems">
                            <template is="dom-repeat" items="{{teamitems}}">
                                <li>
                                    <order-lineitem item="{{item}}" on-remove-item="removeItem"></order-lineitem>
                                </li>
                            </template>
                        </ul>
                        <ul class="lineitems">
                            <template is="dom-repeat" items="{{personalitems}}">
                                <li>
                                    <order-lineitem item="{{item}}" on-remove-item="removeItem"></order-lineitem>
                                </li>
                            </template>
                        </ul>
                    </iron-pages>
                </paper-material>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'order-view',
        properties: {
            order: {
                type: Object,
                observer: '_orderChanged'
            },
            team: Object
        },
        ready: function () {
            this.isOpen = false;
            this.isClosed = false;
            this.isPaid = false;
        },
        _orderChanged: function () {
            // workaround for https://github.com/PolymerElements/paper-tabs/issues/31
            this.async(function () {
                this.isOpen = this.order.status == 'open';
                this.isClosed = this.order.status == 'closed';
                this.isPaid = this.order.status == 'paid';
                this.$.tabs._tabChanged(this.$.teamtab, this.$.personaltab);
            });
        },
        toDate: t => new Date(t).toLocaleDateString(),
        enableAdd: function () {
            this.$.addButton.disabled = false;
        },
        add: function () {
            var item = {
                order: this.order.__firebaseKey__,
                coffee: this.coffee.__firebaseKey__,
                quantity: parseInt(this.quantity),
                size: parseInt(this.bagsize),
                personal: this.ispersonal
            };

            if (this.ispersonal && this.person) {
                item['person'] = this.person.__firebaseKey__;
            }

            var collection = this.ispersonal ? this.$.personalitems : this.$.teamitems;
            collection.add(item);
        },
        removeItem: function (e) {
            var item = e.detail;
            if (item.personal)
                this.$.personalitems.remove(item);
            else
                this.$.teamitems.remove(item);
        }
    });
</script>