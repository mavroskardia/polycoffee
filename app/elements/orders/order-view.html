<dom-module id="order-view">
    <style include="shared-styles"></style>
    <style>
        :host { position: relative; }

        order-add-item,
        order-teamitems,
        order-personalitems,
        order-prices,
        order-closed-summary,
        order-payments,
        paper-card
        { margin: 0.5rem; }

        order-teamitems,
        order-personalitems,
        order-payments,
        paper-card.totals
        {
            width: 32rem;
        }

        paper-icon-button {
            position: absolute;
            top: 14px;
            left: -50px;
        }

        paper-tabs { margin-bottom: 1rem; }
    </style>
    <template>
        <paper-icon-button icon="arrow-back" on-tap="closeView"></paper-icon-button>
        <header class="horizontal layout">
            <h2 class="flex">Order for <span>{{toDate(order.date)}}</span></h2>
            <div class="end self-center">
                <!-- <team-dropdown order="{{order}}" disabled="{{!isOpen}}"></team-dropdown> -->
                <order-action order="[[order]]" class="self-center"
                    on-order-closed="closeOrder"
                    on-order-paid="payOrder">
                </order-action>
            </div>
        </header>

        <paper-tabs selected="{{selected}}">
            <paper-tab>Order</paper-tab>
            <paper-tab>Coffees</paper-tab>
        </paper-tabs>

        <iron-pages selected="{{selected}}">
            <section class="tiles layout horizontal wrap start">
                <div class="layout vertical">
                    <order-add-item order="{{order}}"
                        hidden$="{{!isOpen}}"
                        on-add-coffee="addItemToOrder"
                        on-add-other="addItemToOrder">
                    </order-add-item>
                    <order-closed-summary hidden$="{{!isClosed}}" order="{{order}}"></order-closed-summary>
                    <order-payments hidden$="{{!isPaid}}" order="{{order}}"></order-payments>
                </div>
                <div class="layout vertical">
                    <order-teamitems order="{{order}}" on-remove-item="removeItem"></order-teamitems>
                    <order-personalitems order="{{order}}" on-remove-item="removeItem"></order-personalitems>
                    <paper-card class="totals" heading="Order Totals">
                        <div class="card-contents">
                            <order-totals order="{{order}}"></order-totals>
                        </div>
                    </paper-card>
                </div>
            </section>
            <section>
                <order-coffee-list order="{{order}}"></order-coffee-list>
                <order-prices order="{{order}}" on-price-update="updateOrder"></order-prices>
            </section>
        </iron-pages>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'order-view',
        properties: {
            team: Object,
            order: {
                type: Object,
                notify: true,
                observer: '_orderChanged'
            },
            isOpen: {
                type: Boolean,
                computed: 'isOrderOpen(order)'
            },
            isClosed: {
                type: Boolean,
                computed: 'isOrderClosed(order)'
            },
            isPaid: {
                type: Boolean,
                computed: 'isOrderPaid(order)'
            },
            selected: {
                type: Number,
                value: () => 0
            }
        },
        orderOpen: function (order) { return order.status === 'open'; },
        isOrderOpen: o => o.status === 'open',
        isOrderClosed: o => o.status === 'closed',
        isOrderPaid: o => o.status === 'paid',
        removeItem: function (e, item) {
            var idx = this.order.items.indexOf(item);
            if (idx > -1) {
                this.splice('order.items', idx, 1);
                this.updateOrder();
            }
        },
        updateOrder: function () {
            this.fb.update(this.order);
        },
        _orderChanged: function () {
            if (!this.order) { return; }
            this.fb = new Firebase('https://swcoffee.firebaseio.com/orders/' + this.order.__firebaseKey__);
        },
        combine: function (order, lineitem) {
            if (!lineitem.isCoffee) { return; }
            var combined = false;
            order.items.filter(i=>i.isCoffee).forEach(i => {
                if (i.coffee.name === lineitem.coffee.name &&
                    i.size === lineitem.size &&
                    i.personal === lineitem.personal &&
                    (!i.personal || i.person.__firebaseKey__ === lineitem.person.__firebaseKey__)) {
                    var iquant = parseInt(i.quantity);
                    var lquant = parseInt(lineitem.quantity);
                    i.quantity = iquant + lquant;
                    combined = true;
                    return false;
                }
            });

            return combined;
        },
        addItemToOrder: function (e, lineitem) {
            if (!this.order.items) {
                this.set('order.items', []);
            }

            if (!this.combine(this.order, lineitem)) {
               this.push('order.items', lineitem);
            }
            this.updateOrder();
        },
        toDate: t => new Date(t).toLocaleDateString(),
        closeOrder: function () {
            this.fb.update({'status': 'closed', 'closed_date': new Date().getTime() });
        },
        bagCost: function (item) {
            if (!item.isCoffee) { return 0; }
            return this.order.prices
                    .filter(p => p.retail == item.coffee.price)
                    .map(p => p.wholesale[item.size == 1 ? 0 : item.size == 2 ? 1 : 2])
                    .reduce((p,c)=> p + c, 0.0);
        },
        getTeamShare: function (order) {
            var teamTotal = order.items
                                .filter(i => !i.personal)
                                .map(i => i.quantity * this.bagCost(i) * 100)
                                .concat(order.items
                                    .filter(i => !i.isCoffee)
                                    .map(i => i.price * i.quantity))
                                .reduce((a,b) => a + b, 0.0);

            return this.teamTotal / order.people.filter(p => p.sharing).length;
        },
        getOwed: function (order, person) {
            var total = order.items
                            .filter(i => i.isCoffee && i.personal && i.person.__firebaseKey__ === person.__firebaseKey__)
                            .map(i => i.quantity * this.bagCost(i) * 100)
                            .reduce((a,b) => a + b, 0.0);

            total += person.sharing ? this.getTeamShare(order) : 0;
            return total;
        },
        payOrder: function () {
            var payments = this.order.people.
                map(p => ({
                    person: p,
                    owed: this.getOwed(this.order, p),
                    paid: 0.0
                })).
                filter(p => p.owed > 0);

            this.fb.update({
                'status': 'paid',
                'paid_date': new Date().getTime(),
                'payments': payments
            });
        },
        closeView: function () {
            this.fire('view-closed');
        }
    });
</script>
