<dom-module id="order-view">
    <style include="shared-styles"></style>
    <style>
        :host {
            position: relative;
        }

        order-add-coffee,
        order-add-other,
        order-teamitems,
        order-personalitems,
        order-prices,
        paper-card
        { margin: 0 0.5rem 0.25rem; }

        paper-icon-button {
            position: absolute;
            top: 14px;
            left: -50px;
        }

        paper-tabs {
            margin-bottom: 1rem;
        }
    </style>
    <template>
        <paper-icon-button icon="arrow-back" on-tap="closeView"></paper-icon-button>
        <header class="horizontal layout">
            <h2 class="flex">Order for <span>{{toDate(order.date)}}</span></h2>
            <div class="end self-center">
                <team-dropdown order="{{order}}" disabled="{{!isOpen}}"></team-dropdown>
                <order-action order="[[order]]" class="self-center"
                    on-order-closed="closeOrder"
                    on-order-paid="payOrder">
                </order-action>
            </div>
        </header>

        <paper-tabs selected="{{selected}}">
            <paper-tab>Order</paper-tab>
            <paper-tab>Coffees</paper-tab>
        </paper-tabs>

        <iron-pages selected="{{selected}}">
            <div class="tiles layout horizontal wrap start">
                <order-add-item
                    coffees="{{order.inventory}}"
                    prices="{{order.prices}}"
                    on-add-coffee="addItemToOrder"
                    on-add-other="addItemToOrder">
                </order-add-item>
                <div class="layout vertical">
                    <order-teamitems order="{{order}}" on-remove-item="removeItem"></order-teamitems>
                    <order-personalitems order="{{order}}" on-remove-item="removeItem"></order-personalitems>
                    <paper-card heading="Order Totals">
                        <div class="card-contents">
                            <order-totals order="{{order}}"></order-totals>
                        </div>
                    </paper-card>
                </div>
            </div>
            <section>
                <order-prices order="{{order}}" on-price-update="updateOrder"></order-prices>
            </section>
            <section></section>
        </iron-pages>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'order-view',
        properties: {
            team: Object,
            order: {
                type: Object,
                notify: true,
                observer: '_orderChanged'
            },
            selected: {
                type: Number,
                value: () => 0
            }
        },
        removeItem: function (e, item) {
            var idx = this.order.items.indexOf(item);
            if (idx > -1) {
                this.splice('order.items', idx, 1);
                this.updateOrder();
            }
        },
        updateOrder: function () {
            this.fb.update(this.order);
        },
        _orderChanged: function () {
            if (!this.order) return;
            this.fb = new Firebase('https://swcoffee.firebaseio.com/orders/' + this.order.__firebaseKey__);
        },
        addItemToOrder: function (e, lineitem) {
            if (!this.order.items) this.set('order.items', []);
            this.push('order.items', lineitem);
            this.updateOrder();
        },
        toDate: t => new Date(t).toLocaleDateString(),
        closeOrder: function () {
            this.fb.update({'status': 'closed'});
        },
        payOrder: function () {
            this.fb.update({'status': 'paid'});
        },
        closeView: function () {
            this.fire('view-closed');
        }
    });
</script>
