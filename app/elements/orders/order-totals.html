<dom-module id="order-totals">
    <style include="shared-styles"></style>
    <style>
        .data > * { margin: 0 0.25rem; }
        .spaceonleft { display: inline-block; margin: 0 0 0 0.5rem; }
    </style>
    <template>
        <div class="horizontal layout wrap data">
            <div class="vertical layout">
                <div class="horizontal layout">
                    <span class="flex">Team Items: </span>
                    <strong class="spaceonleft">{{numTeamItems}}</strong>
                </div>
                <div class="horizontal layout">
                    <span class="flex">Personal Items: </span>
                    <strong class="spaceonleft">{{numPersonalItems}}</strong>
                </div>
            </div>
            <div class="vertical layout">
                <div class="horizontal layout">
                    <span class="flex">Total weight: </span>
                    <strong class="spaceonleft">{{totalWeight}}</strong>
                    <span>#</span>
                </div>
                <div class="horizontal layout">
                    <span class="flex">Team member share: </span>
                    <currency-display class="spaceonleft" value="{{teamShare}}"></currency-display>
                </div>
            </div>
            <div class="vertical layout flex">
                <div class="horizontal layout">
                    <span class="flex">Team: </span>
                    <currency-display class="spaceonleft" value="{{teamTotal}}"></currency-display>
                </div>
                <div class="horizontal layout">
                    <span class="flex">Personal: </span>
                    <currency-display class="spaceonleft" value="{{personalTotal}}"></currency-display>
                </div>
                <div class="horizontal layout">
                    <span class="flex">Grand: </span>
                    <currency-display class="spaceonleft" value="{{grandTotal(teamTotal, personalTotal)}}"></currency-display>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'order-totals',
        properties: {
            order: {
                type: Object,
                observer: '_orderChanged'
            },
            totalWeight: {
                type: Number,
                value: () => 0
            },
            teamTotal: {
                type: Number,
                value: () => 0
            },
            teamShare: {
                type: Number,
                value: () => 0
            },
            personalTotal: {
                type: Number,
                value: () => 0
            }
        },
        _orderChanged: function (newOrder) {
            if (!newOrder) return;
            this.calculateTotals(newOrder);
        },
        calculateTotals: function (order) {
            if (!order.items) return;

            var teamitems = order.items.filter(i => i.isCoffee && !i.personal);

            this.numTeamItems = teamitems.length;

            this.totalWeight = order.items
                                    .filter(i => i.isCoffee)
                                    .map(i => i.size * i.quantity)
                                    .reduce((a,b) => a + b, 0.0);

            this.teamTotal = teamitems
                                    .map(i => i.quantity * this.bagCost(i) * 100)
                                    .concat(order.items
                                        .filter(i => !i.isCoffee)
                                        .map(i => i.price * i.quantity))
                                    .reduce((a,b) => a + b, 0.0);

            this.teamShare = this.teamTotal / order.people.filter(p => p.team == order.team).length;

            var personalitems = order.items.filter(i => i.personal);

            this.numPersonalItems = personalitems.length;

            this.personalTotal = personalitems
                                    .map(i => i.quantity * this.bagCost(i) * 100)
                                    .reduce((a,b) => a + b, 0.0);
        },
        bagCost: function (item) {
            return this.order.prices
                    .filter(p => p.retail == item.coffee.price)
                    .map(p => p.wholesale[item.size == 1 ? 0 : item.size == 2 ? 1 : 2])
                    .reduce((p,c)=> p + c, 0.0);
        },
        grandTotal: function (team, personal) {
            return team + personal;
        }
    });
</script>