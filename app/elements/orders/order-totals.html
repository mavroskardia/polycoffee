<dom-module id="order-totals">
    <style>
        .weight { margin-right: 1rem; }
        .numbers { text-align: right; }
        .grand { border-top: solid 1px #ccc; }
    </style>
    <template>
        <firebase-collection
            location="https://swcoffee.firebaseio.com/people/"
            order-by-child="team"
            equal-to="[[order.team]]"
            data="{{people}}">
        </firebase-collection>
        <div class="horizontal layout">
            <div class="weight vertical layout">
                <span>Total weight: <strong>{{totalWeight}}</strong> lbs.</span>
                <span>Team member share: <currency-display value="{{teamShare}}"></currency-display></span>
            </div>
            <div class="numbers">
                <div class="team">
                    <span>
                        Team: <currency-display value="{{teamTotal}}"></currency-display>
                    </span>
                </div>
                <div class="personal">
                    <span>
                        Personal: <currency-display value="{{personalTotal}}"></currency-display>
                    </span>
                </div>
                <div class="grand">
                    <span>
                        Grand Total: <currency-display value="{{grandTotal(teamTotal, personalTotal)}}"></currency-display>
                    </span>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'order-totals',
        properties: {
            order: {
                type: Object,
                observer: '_orderChanged'
            }
        },
        _orderChanged: function (newOrder) {
            if (!newOrder) return;
            this.calculateTotals(newOrder);
        },
        calculateTotals: function (order) {
            this.teamTotal = 0.0;
            this.share = 0.0;
            this.totalWeight = 0.0;
            this.calculateTeamTotal(order);
            this.calculatePersonalTotal(order);
            this.calculateTeamShare(order);
        },
        calculateTeamTotal: function (order) {
            var teamref = new Firebase('https://swcoffee.firebaseio.com/teamitems');
            var inventoryref = new Firebase('https://swcoffee.firebaseio.com/inventory');

            teamref.orderByChild('order').equalTo(order.__firebaseKey__).on('child_added', function (ss) {
                var item = ss.val();
                inventoryref.child(item.item).on('value', function (sss) {
                    var inv = sss.val();
                    this.teamTotal += inv.price * parseInt(item.quantity);
                    this.totalWeight += (item.size || 0) * item.quantity;
                }.bind(this));
            }.bind(this));
        },
        calculatePersonalTotal: function (order) {
            this.personalTotal = 0.0;

            var personalref = new Firebase('https://swcoffee.firebaseio.com/personalitems');
            var inventoryref = new Firebase('https://swcoffee.firebaseio.com/inventory');

            personalref.orderByChild('order').equalTo(order.__firebaseKey__).on('child_added', function (ss) {
                var item = ss.val();
                inventoryref.child(item.item).on('value', function (sss) {
                    var inv = sss.val();
                    this.personalTotal += inv.price * parseInt(item.quantity);
                    this.totalWeight += item.size * item.quantity;
                }.bind(this));
            }.bind(this));
        },
        calculateTeamShare: function () {
            if (this.people)
                this.teamShare = (this.teamTotal / this.people.length) || 0.0;
            else
                this.teamShare = 0.0;
        },
        grandTotal: function (team, personal) {
            return team + personal;
        }
    });
</script>